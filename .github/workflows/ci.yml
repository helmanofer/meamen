name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: cd client && bun install --frozen-lockfile
      - run: bun run lint
      - run: bun run lint:client

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bunx prisma generate --schema prisma/schema.sqlite.prisma
      - run: bun test

  # deploy-fly:
  #   name: Deploy to Fly.io
  #   runs-on: ubuntu-latest
  #   needs: [lint, test]
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: superfly/flyctl-actions/setup-flyctl@master
  #     - run: flyctl deploy --remote-only
  #       env:
  #         FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  deploy-render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Trigger Render deploy
        id: trigger
        run: |
          RESPONSE=$(curl -sf "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" || true)
          echo "Response: $RESPONSE"
          DEPLOY_ID=$(echo "$RESPONSE" | jq -r '.deploy.id // empty')
          if [ -z "$DEPLOY_ID" ]; then
            echo "::error::Failed to trigger deploy. Response: $RESPONSE"
            exit 1
          fi
          echo "deploy_id=$DEPLOY_ID" >> "$GITHUB_OUTPUT"
          echo "Triggered deploy: $DEPLOY_ID"
      - name: Wait for deploy to complete
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          DEPLOY_ID: ${{ steps.trigger.outputs.deploy_id }}
          SERVICE_ID: srv-d64e7evpm1nc73b9apn0
        run: |
          for i in $(seq 1 60); do
            STATUS=$(curl -s "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID" \
              -H "Authorization: Bearer $RENDER_API_KEY" | jq -r '.status')
            echo "Attempt $i: status=$STATUS"
            case "$STATUS" in
              live)
                echo "Deploy succeeded!"
                exit 0
                ;;
              build_failed|update_failed|canceled|deactivated)
                echo "Deploy failed with status: $STATUS"
                exit 1
                ;;
            esac
            sleep 10
          done
          echo "Deploy timed out after 10 minutes"
          exit 1
